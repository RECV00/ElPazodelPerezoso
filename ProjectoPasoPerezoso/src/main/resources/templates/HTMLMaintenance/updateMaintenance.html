<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <div th:fragment="updateModal">
        <!-- Modal para actualizar mantenimiento -->
        <div class="modal fade" id="updateMaintenanceModal" tabindex="-1" aria-labelledby="updateMaintenanceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="updateMaintenanceModalLabel">Actualizar Mantenimiento</h2>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" th:action="@{/maintenance/updateM}" enctype="multipart/form-data" id="updateMaintenanceForm" class="needs-validation" novalidate>
                        <div class="modal-body">
                            <div class="row g-3">
                                <!-- Columna 1 -->
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="maintenanceDate" class="form-label fw-bold">Fecha de Mantenimiento:</label>
                                        <input type="date" class="form-control" id="maintenanceDate" name="maintenanceDate" th:field="*{maintenanceDate}" required>
                                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="maintenanceType" class="form-label fw-bold">Tipo de Mantenimiento:</label>
                                        <select class="form-control" id="maintenanceType" name="maintenanceType" th:field="*{maintenanceType}" required>
                                            <option value="">Seleccione</option>
                                            <option value="Preventivo">Preventivo</option>
                                            <option value="Correctivo">Correctivo</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor seleccione un tipo de mantenimiento.</div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="description" class="form-label fw-bold">Descripción:</label>
                                        <textarea class="form-control" id="description" name="description" rows="3" th:field="*{description}" required></textarea>
                                        <div class="invalid-feedback">Por favor ingrese una descripción.</div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="location" class="form-label fw-bold">Ubicación:</label>
                                        <input type="text" class="form-control" id="location" name="location" th:field="*{location}" required>
                                        <div class="invalid-feedback">Ingrese una ubicación válida.</div>
                                    </div>
                                </div>
                                <!-- Columna 2 -->
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="priorities" class="form-label fw-bold">Prioridad:</label>
                                        <select class="form-control" id="priorities" name="priorities" th:field="*{priorities}" required>
                                            <option value="">Seleccione</option>
                                            <option value="alta">Alta</option>
                                            <option value="media">Media</option>
                                            <option value="baja">Baja</option>
                                        </select>
                                        <div class="invalid-feedback">Seleccione una prioridad válida.</div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="state" class="form-label fw-bold">Estado:</label>
                                        <select class="form-control" id="state" name="state" th:field="*{state}" required>
                                            <option value="">Seleccione</option>
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="En proceso">En proceso</option>
                                            <option value="Terminada">Terminada</option>
                                        </select>
                                        <div class="invalid-feedback">Seleccione un estado válido.</div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="assignedPersonal" class="form-label fw-bold">Personal Asignado:</label>
                                        <select class="form-control" id="assignedPersonal" name="assignedPersonal" th:field="*{assignedPersonal}" required>
                                            <option value="">Seleccione</option>
                                            <option value="Técnico">Técnico</option>
                                            <option value="Usuario">Usuario</option>
                                        </select>
                                        <div class="invalid-feedback">Seleccione un personal asignado válido.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-submit">Actualizar Mantenimiento</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

   <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('modalUpdate');
            const modalBody = document.getElementById('modalBody');

            document.querySelectorAll('.edit').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');

                    fetch(`/maintenance/FormUpdate?id=${id}`)
                        .then(response => {
                            if (!response.ok) throw new Error("No se pudo cargar el formulario");
                            return response.text();
                        })
                        .then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const bodyContent = doc.querySelector('body').innerHTML;

                            modalBody.innerHTML = '<span class="cerrar">&times;</span>' + bodyContent;
                            modal.style.display = 'block';
                        })
                        .catch(error => {
                            modalBody.innerHTML = '<p style="color: red;">Error al cargar el formulario</p>';
                            modal.style.display = 'block';
                        });
                });
            });

            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('cerrar')) {
                    modal.style.display = 'none';
                }
            });

            window.onclick = function (event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        });
    </script>
</body>
</html>
